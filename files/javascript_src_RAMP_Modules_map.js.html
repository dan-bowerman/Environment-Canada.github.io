<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>javascript\src\RAMP\Modules\map.js - RAMP GIS Viewer</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..\..\..\assets\images\arctic_fox_logo_200x100.png" title="RAMP GIS Viewer"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.8-0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Array.html">Array</a></li>
            
                <li><a href="../classes/BaseMapSelector.html">BaseMapSelector</a></li>
            
                <li><a href="../classes/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../classes/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../classes/CheckboxWrapper.html">CheckboxWrapper</a></li>
            
                <li><a href="../classes/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../classes/DatagridClickHandler.html">DatagridClickHandler</a></li>
            
                <li><a href="../classes/Decorator.html">Decorator</a></li>
            
                <li><a href="../classes/Dictionary.html">Dictionary</a></li>
            
                <li><a href="../classes/EventManager.html">EventManager</a></li>
            
                <li><a href="../classes/FeatureClickHandler.html">FeatureClickHandler</a></li>
            
                <li><a href="../classes/FeatureHighlighter.html">FeatureHighlighter</a></li>
            
                <li><a href="../classes/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../classes/FunctionMangler.html">FunctionMangler</a></li>
            
                <li><a href="../classes/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../classes/GraphicExtension.html">GraphicExtension</a></li>
            
                <li><a href="../classes/GUI.html">GUI</a></li>
            
                <li><a href="../classes/Map.html">Map</a></li>
            
                <li><a href="../classes/Maptips.html">Maptips</a></li>
            
                <li><a href="../classes/Navigation.html">Navigation</a></li>
            
                <li><a href="../classes/Popup.html">Popup</a></li>
            
                <li><a href="../classes/PopupBase.html">PopupBase</a></li>
            
                <li><a href="../classes/PopupBaseSettings.html">PopupBaseSettings</a></li>
            
                <li><a href="../classes/PopupManager.html">PopupManager</a></li>
            
                <li><a href="../classes/Prototype.html">Prototype</a></li>
            
                <li><a href="../classes/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../classes/RAMP.html">RAMP</a></li>
            
                <li><a href="../classes/RampMap.html">RampMap</a></li>
            
                <li><a href="../classes/RAMPStarter.html">RAMPStarter</a></li>
            
                <li><a href="../classes/SidePanel.html">SidePanel</a></li>
            
                <li><a href="../classes/SubPanel.html">SubPanel</a></li>
            
                <li><a href="../classes/SubPanelSettings.html">SubPanelSettings</a></li>
            
                <li><a href="../classes/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../classes/Url.html">Url</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../modules/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../modules/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../modules/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../modules/Map.html">Map</a></li>
            
                <li><a href="../modules/Maptips.html">Maptips</a></li>
            
                <li><a href="../modules/Navigation.html">Navigation</a></li>
            
                <li><a href="../modules/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../modules/RAMP.html">RAMP</a></li>
            
                <li><a href="../modules/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/Utils.html">Utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: javascript\src\RAMP\Modules\map.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿/*global define, esri */

/**
*
* A RAMP Map module with ESRI and Dojo AMD Modules
* This module provides function to create an ESRI web map control. A global config object is
* required to initialize the map.
*
* @module RAMP
* @submodule Map
* @main Map
*/

/**
* Map class represents the ESRI map object. The map is generated based on the application configuration and templates. 
*
* @class Map
* @uses dojo/_base/declare
* @uses dojo/_base/array
* @uses dojo/dom
* @uses dojo/dom-class
* @uses dojo/dom-construct
* @uses dojo/number
* @uses dojo/query
* @uses dojo/_base/lang
* @uses dojo/topic
* @uses dojo/on
* @uses esri/map
* @uses esri/layers/FeatureLayer
* @uses esri/layers/ArcGISTiledMapServiceLayer
* @uses esri/layers/ArcGISDynamicMapServiceLayer
* @uses esri/tasks/GeometryService
* @uses esri/tasks/ProjectParameters
* @uses esri/geometry/Polygon
* @uses esri/SpatialReference
* @uses esri/dijit/Scalebar
* @uses esri/geometry/Extent
* @uses esri/graphicsUtils
* @uses GlobalStorage
* @uses RAMP
* @uses FeatureClickHandler
* @uses Util
* @uses Array
* @uses Dictionary
* @uses GUI
* @uses Navigation
* @uses EventManager
*/

define([
/* Dojo */
&quot;dojo/_base/declare&quot;, &quot;dojo/_base/array&quot;, &quot;dojo/dom&quot;, &quot;dojo/dom-class&quot;,
        &quot;dojo/dom-construct&quot;, &quot;dojo/number&quot;, &quot;dojo/query&quot;, &quot;dojo/_base/lang&quot;, &quot;dojo/topic&quot;, &quot;dojo/on&quot;,

/* Esri */
&quot;esri/map&quot;, &quot;esri/layers/FeatureLayer&quot;, &quot;esri/layers/ArcGISTiledMapServiceLayer&quot;, &quot;esri/layers/ArcGISDynamicMapServiceLayer&quot;,
&quot;esri/tasks/GeometryService&quot;, &quot;esri/tasks/ProjectParameters&quot;, &quot;esri/geometry/Polygon&quot;, &quot;esri/SpatialReference&quot;,
&quot;esri/dijit/Scalebar&quot;, &quot;esri/geometry/Extent&quot;, &quot;esri/graphicsUtils&quot;,

/* Ramp */
&quot;ramp/globalStorage&quot;, &quot;ramp/ramp&quot;, &quot;ramp/featureClickHandler&quot;, &quot;ramp/navigation&quot;, &quot;ramp/eventManager&quot;,

/* Util */
&quot;utils/util&quot;, &quot;utils/array&quot;, &quot;utils/dictionary&quot;],

    function (
    /* Dojo */
    declare, dojoArray, dom, domClass, domConstruct, number, query, dojoLang, topic, dojoOn,

    /* Esri */
    EsriMap, FeatureLayer, ArcGISTiledMapServiceLayer, ArcGISDynamicMapServiceLayer,
    GeometryService, ProjectParameters, Polygon, SpatialReference,
    EsriScalebar, EsriExtent, esriGraphicUtils,

    /* Ramp */
    GlobalStorage, Ramp, FeatureClickHandler, Navigation, EventManager,

    /* Util */
    utilMisc, utilArray, utilDict) {
        &quot;use strict&quot;;

        /**
        * An Array of {{#crossLink &quot;Esri/layer/FeatureLayer&quot;}}{{/crossLink}} objects.
        *
        * @private
        * @property featureLayers {Array}
        */
        var featureLayers,

        /**
        * Maps graphicsLayerId to a GraphicsLayer Object that represents an extent bounding box.
        * A dictionary of String, {{#crossLink &quot;Esri/layer/GraphicsLayer&quot;}}{{/crossLink}} pairs.
        *
        * @private
        * @property attributeLayers {Object}
        */
            attributeLayers,

        /**
        * The map not only contains feature layers, but also other layers such as the
        * basemap layer, highlight layer, bounding box layer, etc. This variable is
        * used to store the starting index of the feature layers in the map.
        *
        * @private
        * @property featureLayerStartIndex {Integer}
        */
            featureLayerStartIndex,

            map,

            fullExtent,
            maxExtent,
            initExtent;

        /**
        * Shows the loading image.
        *
        * @private
        * @method _showLoadingImg
        * @param event {Object}
        */
        function _showLoadingImg() {
            $(&quot;#map-load-indicator&quot;).removeClass(&quot;hidden&quot;);
        }

        /**
        * Hides the loading image.
        *
        * @private
        * @method  _hideLoadingImg
        * @param event {Object}
        */
        function _hideLoadingImg() {
            $(&quot;#map-load-indicator&quot;).addClass(&quot;hidden&quot;);
        }

        /**
        * Update Map Scale when zoom level changes
        *
        * @private
        * @method _updateScale
        * @param event {Object}
        */
        function _updateScale(event) {
            if (event.levelChange) {
                var currentScale = number.format(event.lod.scale);
                var scaleLabelText = &quot;1 : &quot; + currentScale;
                domConstruct.empty(&#x27;scaleLabel&#x27;);
                $(&quot;#scaleLabel&quot;).text(scaleLabelText);
            }
        }

        /**
        * Initialize Map Scale
        *
        * @private
        * @method  _initScale
        * @param event {Object}
        */
        function _initScale(event) {
            var map = event.map;
            var scaleDiv = domConstruct.create(&quot;div&quot;, {
                id: &quot;scaleDiv&quot;,
                &quot;class&quot;: &quot;esriScalebarLabel&quot;
            });
            $(scaleDiv).html(&quot;&lt;span&gt;Scale&lt;/span&gt;&lt;br&gt;&lt;span id=&#x27;scaleLabel&#x27;&gt;&lt;span/&gt;&quot;);
            var currentScale = number.format(map.getScale());
            var scaleLabelText = &quot;1 : &quot; + currentScale;
            domConstruct.place(scaleDiv, query(&quot;.esriScalebarRuler&quot;)[0], &quot;before&quot;);
            domConstruct.empty(&#x27;scaleLabel&#x27;);
            $(&quot;#scaleLabel&quot;).text(scaleLabelText);

            // Change the css class of the scale bar so it shows up against
            // the map
            topic.subscribe(EventManager.BasemapSelector.BASEMAP_CHANGED, function (attr) {
                $(&quot;.esriScalebar &gt; div&quot;).removeClass().addClass(attr.cssStyle);
            });
        }

        /**
        * Republishes map events to the outside using topic.publish
        *
        * @method _initRepublishers
        * @param {Object} map object
        * @private
        */
        function _initRepublishers(map) {
            var prefix = &quot;map&quot;;

            /**
            * Republish map events using topic.publish
            *
            * @method republish
            * @param {String} name
            * @private
            */
            function republish(name) {
                map.on(name, function (event) {
                    topic.publish(prefix + &quot;/&quot; + name, event);
                });
            }

            republish(&quot;update-end&quot;);
            republish(&quot;extent-change&quot;);
            republish(&quot;zoom-start&quot;);
            republish(&quot;zoom-end&quot;);
            republish(&quot;pan-start&quot;);
            republish(&quot;pan-end&quot;);
        }

        /**
        * Subscribe to external events (published using topic.publish)
        * and react accordingly
        *
        * @method _initListeners
        * @param map {Object} map object
        * @private
        */
        function _initListeners(map) {
            /* SUBSCRIBED EVENTS */
            topic.subscribe(EventManager.Map.CENTER_AT, function (event) {
                map.centerAt(event.point);
            });

            topic.subscribe(EventManager.Map.CENTER_AND_ZOOM, function (event) {
                var point = new esri.geometry.Point(event.graphic.geometry.x, event.graphic.geometry.y, map.spatialReference),
                    d = map.centerAndZoom(point, event.level); // Last parameter is the level

                if (event.callback) {
                    d.then(event.callback);
                }
            });

            topic.subscribe(EventManager.Map.SET_EXTENT, function (event) {
                event.extent.spatialReference = map.spatialReference;
                var d = map.setExtent(event.extent);

                if (event.callback) {
                    d.then(event.callback);
                }
            });

            /* NAVIGATION EVENTS */
            topic.subscribe(EventManager.Navigation.PAN, function (event) {
                // event.direction panUp, panDown, panLeft, panRight
                // this same as calling map.panUp(), map.panDown(), map.panLeft(), map.panRight()
                map[event.direction]();
            });

            topic.subscribe(EventManager.Navigation.ZOOM_STEP, function (event) {
                map.setLevel(map.getLevel() + event.level);
            });

            topic.subscribe(EventManager.Navigation.ZOOM, function (event) {
                map.setLevel(event.level);
            });

            topic.subscribe(EventManager.Navigation.FULL_EXTENT, function () {
                map.setExtent(fullExtent);
            });

            /* GUI EVENTS */
            topic.subscribe(EventManager.GUI.LAYOUT_CHANGE, function () {
                map.resize(true);
            });

            // Unhighlight the point when the subpanel is collapsed
            topic.subscribe(EventManager.GUI.SUBPANEL_CHANGE, function (eventArg) {
                // unhighlight only if the panel closing is the details panel
                if (!eventArg.visible &amp;&amp; (eventArg.origin === &quot;rampPopup&quot; || eventArg.origin === &quot;datagrid&quot;)) {
                    topic.publish(EventManager.FeatureHighlighter.HIGHLIGHT_HIDE, {});
                }
            });

            /* START BOUNDING BOX TOGGLE */

            topic.subscribe(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, function (evt) {
                var setTo = evt.node.checked;
                var layerId = evt.node.value;

                // either take url (would need mapping to layer on map),
                // map id in config, graphic layer id
                var layer = map.getLayer(layerId);
                layer.setVisibility(setTo);
                //loops through any static layers that are mapped to the feature layer being toggled
                try {
                    dojoArray.forEach(GlobalStorage.LayerMap[layerId], function (staticLayer) {
                        var layer = map.getLayer(staticLayer);
                        layer.setVisibility(setTo);
                    });
                }
                catch (err) {
                }
            });

            topic.subscribe(EventManager.FilterManager.BOX_VISIBILITY_TOGGLED, function (evt) {
                var boundingBox = attributeLayers[evt.node.value];
                boundingBox.setVisibility(evt.checked);
            });

            topic.subscribe(EventManager.FilterManager.GLOBAL_LAYER_VISIBILITY_TOGGLED, function (evt) {
                dojoArray.forEach(featureLayers, function (layer) {
                    layer.setVisibility(evt.checked);
                    //loops through the all static layers added to the map. Uses the array that maps static layers to feature layers
                    try {
                        dojoArray.forEach(GlobalStorage.LayerMap[layer.id], function (staticLayer) {
                            var layer = map.getLayer(staticLayer);
                            layer.setVisibility(evt.checked);
                        });
                    }
                    catch (err) {
                    }
                });
            });

            topic.subscribe(EventManager.FilterManager.GLOBAL_BOX_VISIBILITY_TOGGLED, function (evt) {
                utilDict.forEachEntry(attributeLayers, function (key, layer) {
                    layer.setVisibility(evt.checked);
                });
            });

            topic.subscribe(EventManager.FilterManager.SELECTION_CHANGED, function (evt) {
                if (!featureLayerStartIndex) {
                    // Find the index of the first feature layer
                    featureLayerStartIndex = utilArray.indexOf(map.graphicsLayerIds, function (layerId) {
                        var layer = map.getLayer(layerId);
                        return layer.type &amp;&amp; layer.type === &quot;Feature Layer&quot;;
                    });
                }
                map.reorderLayer(map.getLayer(evt.id), featureLayerStartIndex + evt.index);
                topic.publish(EventManager.Map.REORDER_END);
            });
            /* END BOUNDING BOX TOGGLE */

            /* Add Layer subscription*/
            topic.subscribe(EventManager.Map.ADD_LAYER, function () {
                var type = dom.byId(&quot;addLayer-select-type&quot;).value;
                var URL = dom.byId(&quot;addLayer-URL-input&quot;).value;
                var opacity = dom.byId(&quot;addLayer-Opacity&quot;).value;
                console.log(type + &quot; | &quot; + URL + &quot; | &quot; + opacity);
                addStaticLayer(type, URL, opacity);
            });

            topic.subscribe(EventManager.Map.ADD_LAYER_READY, function (temp_layer) {
                map.addLayer(temp_layer);
            });
        }
        /**
         * Creates event handlers for the map control: click, mouse-over, load, extent change, and update events.
         * @method _initEventHandlers
         * @param {Object} map A ESRI map object 
         */
        function _initEventHandlers(map) {
            dojoArray.forEach(featureLayers, function (fl) {
                //TODO: set timer for maptips onMouseOver event

                fl.on(&quot;click&quot;, function (evt) {
                    evt.stopImmediatePropagation();
                    FeatureClickHandler.onFeatureSelect(evt);
                });

                fl.on(&quot;mouse-over&quot;, function (evt) {
                    FeatureClickHandler.onFeatureMouseOver(evt);

                    //console.log(&quot;hover on point&quot;, evt);
                });

                fl.on(&quot;mouse-out&quot;, function (evt) {
                    FeatureClickHandler.onFeatureMouseOut(evt);
                });
            });

            map.on(&quot;load&quot;, _initScale);
            map.on(&quot;extent-change&quot;, function (event) {
                _updateScale(event);

                console.log(&quot;map - &gt;&gt; extent-change&quot;);
                dojoOn.once(map, &quot;update-end&quot;, function () {
                    console.log(&quot;map - &gt;&gt; update-end CAUGHT!!&quot;);
                    topic.publish(EventManager.Datagrid.APPLY_EXTENT_FILTER);
                });
            });

            // Deselect all highlighted points if the map is clicked
            map.on(&quot;click&quot;, function (evt) {
                FeatureClickHandler.onFeatureDeselect(evt);
            });

            // Hide all the maptips if the map finishes updating
            map.on(&quot;update-end&quot;, function () {
                //topic.publish(EventManager.Maptips.HIDE, {});
            });

            // Show/Hide spinner for map loading
            map.on(&quot;update-start&quot;, _showLoadingImg);
            map.on(&quot;update-end&quot;, _hideLoadingImg);
        }

        /**
        * Instantiates an extent from a JSON config object and spatial reference
        *
        * @private
        * @method createExtent
        * @param extentConfig {Object} the JSON config object
        * @param sr {Esri/SpatialReference} the {{#crossLink &quot;Esri/SpatialReference&quot;}}{{/crossLink}}
        * @return {esri/geometry/Extent} An ESRI extent object based on the config data
        */
        function createExtent(extentConfig, sr) {
            return new EsriExtent(
                extentConfig.xmin, extentConfig.ymin, extentConfig.xmax, extentConfig.ymax, sr);
        }

        /**
        * Add a static, non-interactive Llyer to the map
        * @method AddStaticLayer
        * @param {String} layer_type A value which controls how the layer is going to be added to the map
        * @param {String} layer_url A URL pointing to a valid map service endpoint
        * @param {Number} layer_op A value between 0.0 and 1.0 which determines the transparency of the layer
        */
        function addStaticLayer(layer_type, layer_url, layer_op) {
            layer_op = layer_op / 100; // change percentage to decimal
            var tempLayer;
            switch (layer_type) {
                case &quot;feature&quot;:
                    tempLayer = new FeatureLayer(layer_url, {
                        opacity: layer_op,
                        mode: FeatureLayer.MODE_SNAPSHOT
                    });
                    break;

                case &quot;tile&quot;:
                    tempLayer = new ArcGISTiledMapServiceLayer(layer_url, {
                        opacity: layer_op
                    });
                    break;

                case &quot;dynamic&quot;:
                    tempLayer = new ArcGISDynamicMapServiceLayer(layer_url, {
                        opacity: layer_op
                    });
                    break;

                default:

                    break;
            }

            topic.publish(EventManager.Map.ADD_LAYER_READY, tempLayer);
            topic.publish(EventManager.GUI.ADD_LAYER_PANEL_CHANGE, {
                visible: false
            });
        }

        return {
            /**
             * The maximum extent of the map control is allowed to go to
             * @property getMaxExtent
             * @type {Object}
             * 
             */
            getMaxExtent: function () {
                return maxExtent;
            },
            /**
             * Return the map control object
             * @property getMap
             * @type {Object}
             * 
             */
            getMap: function () {
                if (utilMisc.isUndefined(map)) {
                    console.log(&quot;trying to get map before it is available!&quot;);
                }
                return map;
            },

            /**
            * Returns a list of feature layers that are currently visible on the map.
            * @method getVisibleFeatureLayers
            * @return {Array} an array of {{#crossLink &quot;Esri/layer/FeatureLayer&quot;}}{{/crossLink}} objects
            * 
            */
            getVisibleFeatureLayers: function () {
                // Return only the feature layers
                //TODO do we need to consider static layers here?
                return dojoArray.filter(map.getLayersVisibleAtScale(), function (layer) {
                    return layer.type &amp;&amp; (layer.type === &quot;Feature Layer&quot;);
                });
            },

            /**
            * Return the feature layer corresponding to the given url.
            *
            * @method getFeatureLayer
            * @private
            * @param featureUrl {String} the url of the feature layer
            * @return {Esri/layer/FeatureLayer} feature layer
            */
            getFeatureLayer: function (featureUrl) {
                return utilArray.find(featureLayers,
                    function (featureLayer) {
                        return featureLayer.url === featureUrl;
                    });
            },

            /**
            * Given an ESRI Extent Object, returns a new ESRI Extent Object that
            * contains the extent adjusted according to this map&#x27;s maximum extent
            *
            * NOTE: this method is currently unused!
            *
            * @param e {esri/geometry/Extent} the extent Object
            * @param maxExtent {esri/geometry/Extent} the maximum extent
            * @return {esri/geometry/Extent}An adjusted extent, if the target extent is outside the boundary
            * @method checkBoundary
            */
            checkBoundary: function (e, maxExtent) {
                var extent = e,
                width = extent.width(),
                height = extent.height(),
                centerX = extent.centerX(),
                centerY = extent.centerY(),
                flag, adjustedEx;

                adjustedEx = extent.clone();

                var maxHeight = maxExtent.height();
                if (height &gt; maxHeight) {
                    height = maxHeight;
                }

                if (centerY &gt; maxExtent.ymax) {
                    adjustedEx.ymax = maxExtent.ymax;
                    adjustedEx.ymin = maxExtent.ymax - height;
                    flag = true;
                    //} else if (extent.ymin &lt; maxExtent.ymin) {
                } else if (centerY &lt; maxExtent.ymin) {
                    adjustedEx.ymin = maxExtent.ymin;
                    adjustedEx.ymax = maxExtent.ymin + height;
                    flag = true;
                }

                var maxWidth = maxExtent.width();
                if (width &gt; maxWidth) {
                    width = maxWidth;
                }

                if (centerX &gt; maxExtent.xmax) {
                    adjustedEx.xmax = maxExtent.xmax;
                    adjustedEx.xmin = maxExtent.xmax - width;
                    flag = true;
                } else if (centerX &lt; maxExtent.xmin) {
                    adjustedEx.xmin = maxExtent.xmin;
                    adjustedEx.xmax = maxExtent.xmin + width;
                    flag = true;
                }

                if (flag) {
                    return adjustedEx;
                }
            },
            /*
            * Initialize map control with configuration objects provided in the bootstrapper.js file.
            *
            * Initialize extent
            * Add base map from the config.basemaps array that has the showOnInit()
            * Add Static layer from config.featureLayers.staticLayers
            * Add feature layers from config.featureLayers
            * Create bounding layers and add to map control
            * Add map tip events to each feature layer (click/hover/out)
            * Show scalebar
            * Publish events to outside for other modules to use
            * Subscribe events to update map control
            *
            * Note: Not sure if we want to include all the config requirements here.
            * Map control is initialized with div id provided. The following config file entries are used:
            * config.spatialReference
            * config.extents.defaultExtent xmin, ymin, xmax, ymax
            * config.levelOfDetails.minLevel
            * config.levelOfDetails.maxLevel
            * config.extents.maximumExtent
            * config.extents.fullExtent
            * config.basemaps  arrays of basemap, only one or first one with showOnInit set to true
            * config.featureLayers
            * 
            * @method init
            * @param {Object} mapDiv the HTML div that will store the map control
            * @constructor
            * 
            */
            init: function (mapDiv) {
                //config object is loaded in bootstrapper.js
                var config = GlobalStorage.config,

                /**
                * The spatial reference of the map
                *
                * @property spatialReference
                * @private
                * @type {esri/SpatialReference}
                */
                    spatialReference = new esri.SpatialReference({
                        wkid: config.spatialReference
                    }),

                /**
                * The URL of the basemap that is on by default
                *
                * @property url
                * @private
                * @type {String}
                */
                    url = utilArray.find(config.basemaps, function (basemap) {
                        return basemap.showOnInit;
                    }).url,

                /**
                * The basemap layer
                *
                * @property baseLayer
                * @private
                * @type {Esri/layers/ArcGISTiledMapServiceLayer}
                */
                    baseLayer = new ArcGISTiledMapServiceLayer(url, {
                        id: &quot;basemapLayer&quot;
                    });

                /**
                * The maximum extent of the map
                *
                * @property maxExtent
                * @private
                * @type {esri/geometry/Extent}
                */
                maxExtent = createExtent(config.extents.maximumExtent, spatialReference);

                /**
                * The initial extent of the map
                *
                * @property InitExtent
                * @private
                * @type {esri/geometry/Extent}
                */
                initExtent = createExtent(config.extents.defaultExtent, spatialReference);

                /**
                * Used for full extent in nav widget
                *
                * @property fullExtent
                * @private
                * @type {esri/geometry/Extent}
                */
                fullExtent = createExtent(config.extents.fullExtent, spatialReference);

                featureLayers = dojoArray.map(config.featureLayers, function (layer) {
                    var fl = new FeatureLayer(layer.url, {
                        id: String.format(&quot;featureLayer_{0}&quot;, Ramp.getLayerConfig(layer.url).displayName),
                        mode: FeatureLayer.MODE_SNAPSHOT,
                        outFields: [layer.layerAttributes]
                    });

                    return fl;
                });

                /**
                * A list GraphicsLayer that represent the extent bounding box of the feature layers.
                *
                * @property boundingBoxLayers
                * @type {array of esri/layer/GraphicsLayer}
                * @param  {[esr/layer/featurelayers]} featureLayers A list of feature layers found in the application config
                * @return {[esri/layer/graphiclayer]}  An array of graphic layers to add to the map
                */
                var boundingBoxLayers = dojoArray.map(featureLayers, function (layer) {
                    // Map a list of featurelayers into a list of GraphicsLayer representing
                    // the extent bounding box of the feature layer (the bounding boxes are initialized
                    // separately, after the feature layers have finished loading (see attributeLayerAdder function
                    // below)
                    var attrLayer = new esri.layers.GraphicsLayer({
                        id: String.format(&quot;boundingBoxLayer_{0}&quot;, Ramp.getLayerConfig(layer.url).displayName),
                        visible: false // bounding boxes are not visible by default
                    });
                    return attrLayer;
                });

                //the map!
                map = new EsriMap(mapDiv, {
                    extent: initExtent,
                    logo: false,
                    minZoom: config.levelOfDetails.minLevel,
                    maxZoom: config.levelOfDetails.maxLevel,
                    slider: false
                });

                // Add the basemap layers
                map.addLayers([baseLayer]);

                /*  START - Add static layers   */

                var staticLayers = [];
                var perLayerStaticMaps = [];
                var staticLayerMap = [];

                dojoArray.map(config.featureLayers, function (layer) {
                    perLayerStaticMaps = [];
                    dojoArray.forEach(layer.staticLayers, function (staticLayer, i) {
                        var tempLayer;
                        //determine layer type and process
                        switch (staticLayer.layerType) {
                            case &quot;feature&quot;:
                                tempLayer = new FeatureLayer(staticLayer.url, {
                                    opacity: staticLayer.opacity,
                                    mode: FeatureLayer.MODE_SNAPSHOT,
                                    id: &quot;static_&quot; + staticLayer.id
                                });
                                break;

                            case &quot;tile&quot;:
                                tempLayer = new ArcGISTiledMapServiceLayer(staticLayer.url, {
                                    opacity: staticLayer.opacity,
                                    id: &quot;static_&quot; + staticLayer.id
                                });
                                console.log(&quot;tile layer added. &quot; + &quot;static_&quot; + staticLayer.id);
                                break;

                            case &quot;dynamic&quot;:
                                tempLayer = new ArcGISDynamicMapServiceLayer(staticLayer.url, {
                                    opacity: staticLayer.opacity,
                                    id: &quot;static_&quot; + staticLayer.id
                                });
                                console.log(&quot;dynamic layer added. &quot; + &quot;static_&quot; + staticLayer.id);
                                break;

                            default:
                                //TODO add in other types of maps... wms?  non-esri tile?
                                break;
                        }

                        staticLayers.push(tempLayer);
                        //creates an array of all static layers defined for the current, single feature layer
                        perLayerStaticMaps[i] = &quot;static_&quot; + staticLayer.id;
                    });
                    //adds the static layer id array as a value to an array indexed by feature layer names
                    staticLayerMap[String.format(&quot;featureLayer_{0}&quot;, Ramp.getLayerConfig(layer.url).displayName)] = perLayerStaticMaps;
                });
                //adds the static layers to the map and copies the static layer/feature layer mapping to the Global Config
                map.addLayers(staticLayers);
                GlobalStorage.LayerMap = staticLayerMap;
                /*  End - Add static layers   */

                // Combine the two layer arrays then add them all at once (for efficiency)
                map.addLayers(boundingBoxLayers.concat(featureLayers));

                // Maps graphicsLayerId to a GraphicsLayer Object that represents an extent bounding box
                attributeLayers = {};

                var attributeLayerAdder = function () {
                    dojoArray.forEach(featureLayers, function (layer, i) {
                        var boundingBoxExtent = esriGraphicUtils.graphicsExtent(layer.graphics);

                        // Make sure the boundingBoxExtent is within the max extent
                        // you want max for xmin, ymin and min for xmax, ymax because
                        // you want to make sure the extent is smaller than the maximum extent
                        boundingBoxExtent.xmin = Math.max(boundingBoxExtent.xmin, maxExtent.xmin);
                        boundingBoxExtent.ymin = Math.max(boundingBoxExtent.ymin, maxExtent.ymin);
                        boundingBoxExtent.xmax = Math.min(boundingBoxExtent.xmax, maxExtent.xmax);
                        boundingBoxExtent.ymax = Math.min(boundingBoxExtent.ymax, maxExtent.ymax);

                        var extentGraphic = new esri.Graphic({
                            &quot;geometry&quot;: boundingBoxExtent,
                            &quot;symbol&quot;: {
                                &quot;color&quot;: [255, 0, 0, 64],
                                &quot;outline&quot;: {
                                    &quot;color&quot;: [240, 128, 128, 255],
                                    &quot;width&quot;: 1,
                                    &quot;type&quot;: &quot;esriSLS&quot;,
                                    &quot;style&quot;: &quot;esriSLSSolid&quot;
                                },
                                &quot;type&quot;: &quot;esriSFS&quot;,
                                &quot;style&quot;: &quot;esriSFSSolid&quot;
                            }
                        });
                        boundingBoxLayers[i].add(extentGraphic);
                        attributeLayers[layer.id] = boundingBoxLayers[i];
                    });
                };

                // Add the attribute layers after the map finishes adding the feature layers
                // makes sure this listener only fires once
                dojoOn.once(map, &quot;update-end&quot;, attributeLayerAdder);

                /* Start - Show scalebar */
                var scalebar = new EsriScalebar({
                    map: map,
                    attachTo: &quot;bottom-left&quot;,
                    scalebarUnit: &quot;metric&quot;
                });

                scalebar.show();

                /* End - Show scalebar */

                _initRepublishers(map);
                _initListeners(map);
                _initEventHandlers(map, featureLayers);
            }
        };
    });
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
