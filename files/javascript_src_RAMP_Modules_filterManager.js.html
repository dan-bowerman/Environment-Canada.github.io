<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>javascript\src\RAMP\Modules\filterManager.js - RAMP GIS Viewer</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..\..\..\assets\images\arctic_fox_logo_200x100.png" title="RAMP GIS Viewer"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.8-0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Array.html">Array</a></li>
            
                <li><a href="../classes/BaseMapSelector.html">BaseMapSelector</a></li>
            
                <li><a href="../classes/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../classes/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../classes/CheckboxWrapper.html">CheckboxWrapper</a></li>
            
                <li><a href="../classes/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../classes/DatagridClickHandler.html">DatagridClickHandler</a></li>
            
                <li><a href="../classes/Decorator.html">Decorator</a></li>
            
                <li><a href="../classes/Dictionary.html">Dictionary</a></li>
            
                <li><a href="../classes/EventManager.html">EventManager</a></li>
            
                <li><a href="../classes/FeatureClickHandler.html">FeatureClickHandler</a></li>
            
                <li><a href="../classes/FeatureHighlighter.html">FeatureHighlighter</a></li>
            
                <li><a href="../classes/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../classes/FunctionMangler.html">FunctionMangler</a></li>
            
                <li><a href="../classes/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../classes/GraphicExtension.html">GraphicExtension</a></li>
            
                <li><a href="../classes/GUI.html">GUI</a></li>
            
                <li><a href="../classes/Map.html">Map</a></li>
            
                <li><a href="../classes/Maptips.html">Maptips</a></li>
            
                <li><a href="../classes/Navigation.html">Navigation</a></li>
            
                <li><a href="../classes/Popup.html">Popup</a></li>
            
                <li><a href="../classes/PopupBase.html">PopupBase</a></li>
            
                <li><a href="../classes/PopupBaseSettings.html">PopupBaseSettings</a></li>
            
                <li><a href="../classes/PopupManager.html">PopupManager</a></li>
            
                <li><a href="../classes/Prototype.html">Prototype</a></li>
            
                <li><a href="../classes/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../classes/RAMP.html">RAMP</a></li>
            
                <li><a href="../classes/RampMap.html">RampMap</a></li>
            
                <li><a href="../classes/RAMPStarter.html">RAMPStarter</a></li>
            
                <li><a href="../classes/SidePanel.html">SidePanel</a></li>
            
                <li><a href="../classes/SubPanel.html">SubPanel</a></li>
            
                <li><a href="../classes/SubPanelSettings.html">SubPanelSettings</a></li>
            
                <li><a href="../classes/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../classes/Url.html">Url</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../modules/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../modules/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../modules/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../modules/Map.html">Map</a></li>
            
                <li><a href="../modules/Maptips.html">Maptips</a></li>
            
                <li><a href="../modules/Navigation.html">Navigation</a></li>
            
                <li><a href="../modules/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../modules/RAMP.html">RAMP</a></li>
            
                <li><a href="../modules/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/Utils.html">Utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: javascript\src\RAMP\Modules\filterManager.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿/*global define, window, tmpl */

/**
* FilterManager submodule
*
* @module RAMP
* @submodule FilterManager
* @main FilterManager
*/

/**
* FilterManager class. Represents the legend next to the map and the controls to toggle each map layer&#x27;s visibility and boundary box.
* The FilterManager also includes a attribute filter that allows the user to hide map features based on a attribute values
* 
* For a doc with diagrams on how this class works, please see
* http://ecollab.ncr.int.ec.gc.ca/projects/science-apps/priv/RAMP/RAMP%20AMD%20Filter%20Module.docx
*
* @class FilterManager
* @static
* @uses dojo/_base/declare
* @uses dojo/_base/lang
* @uses dojo/query
* @uses dojo/_base/array
* @uses dojo/dom
* @uses dojo/dom-class
* @uses dojo/dom-style
* @uses dojo/dom-construct
* @uses dojo/_base/connect
* @uses dojo/Deferred
* @uses dojo/topic
* @uses dojo/aspect
* @uses dojo/promise/all
* @uses templates/filter_manager_Template.html
* @uses esri/tasks/query
* @uses esri/layers/FeatureLayer
* @uses RAMP
* @uses GlobalStorage
* @uses GUI
* @uses Legend
* @uses Util
* @uses Array
* @uses Dictionary
* @uses PopupManager
*/

define([
/* Dojo */
        &quot;dojo/_base/declare&quot;, &quot;dojo/_base/lang&quot;, &quot;dojo/query&quot;, &quot;dojo/_base/array&quot;, &quot;dojo/dom&quot;, &quot;dojo/dom-class&quot;,
        &quot;dojo/dom-style&quot;, &quot;dojo/dom-construct&quot;, &quot;dojo/_base/connect&quot;, &quot;dojo/Deferred&quot;, &quot;dojo/topic&quot;,
        &quot;dojo/aspect&quot;, &quot;dojo/promise/all&quot;,
/* Text */
        &quot;dojo/text!./templates/filter_manager_Template.html&quot;,
        &quot;dojo/text!./templates/filter_row_template.json&quot;,
        &quot;dojo/text!./templates/filter_global_template.json&quot;,

/* Esri */
        &quot;esri/tasks/query&quot;, &quot;esri/layers/FeatureLayer&quot;,

/* Ramp */
        &quot;ramp/ramp&quot;, &quot;ramp/globalStorage&quot;, &quot;ramp/map&quot;, &quot;ramp/eventManager&quot;,

/* Util */
        &quot;utils/tmplHelper&quot;, &quot;utils/util&quot;, &quot;utils/array&quot;, &quot;utils/dictionary&quot;, &quot;utils/popupManager&quot;],

    function (
    /* Dojo */
        declare, lang, query, dojoArray, dom, domClass, domStyle, domConstruct,
        connect, Deferred, topic, aspect, all,
    /* Text */
        filter_manager_Template,
        filter_row_template_json,
        filter_global_row_template_json,

    /* Esri */
        EsriQuery, FeatureLayer,

    /* Ramp */
        Ramp, GlobalStorage, RampMap, EventManager,

    /* Util */
        tmplHelper, utilMisc, utilArray, utilDict, popupManager) {
        &quot;use strict&quot;;

        var config,
            localString,

            ui = (function () {
                var layerList,
                    filterGlobalToggles;
                /**
                 * Generates a data grid row with a checkbox.
                 * @method generateGlobalCheckboxes
                 * @returns {Object} toggleRow the generated data grid row.
                 */
                function generateGlobalCheckboxes() {
                    
                    var toggleRow;
                    
                    // reset and load global template
                    tmpl.cache = {};
                    tmpl.templates = JSON.parse(tmplHelper.stringifyTemplate(filter_global_row_template_json));

                    toggleRow = tmpl(config.siteTemplate.filterGlobalRowTemplate, config.globalFilter);

                    return toggleRow;
                }

                /**
                * Generates legend for each interactive layer on the map (non-basemap layers).
                *
                * @method generateFilterCheckboxes
                * @return {String} a string representation of the legends with simplified layer info for identification
                */
                function generateFilterCheckboxes() {
                    var layers = RampMap.getMap().getLayersVisibleAtScale(),
                        section = &quot;&quot;;

                    // layerLegend data for template,
                    var allLayerData = [];

                    dojoArray.forEach(layers, function (layer) {
                        if (!layer.type || layer.type === &quot;basemap&quot;) {
                            return;
                        }

                        var layerConfig = Ramp.getLayerConfig(layer.url),

                            groupName = layer.id,
                            legendName = &quot;filterGroup_&quot; + groupName,
                            attr = &quot;&quot;,
                            featureId = layerConfig.id;

                        
                        /** Building data for template
                        * @example
                        *       var visibilityLegendLabel = { &quot;for&quot;: legendName, &quot;attr&quot;: attr, &quot;value&quot;: groupName,
                        *       checked&quot;: &quot;checked&quot;, &quot;label&quot;: &quot;Show&quot;, &quot;class&quot;: &quot;eye checked&quot;
                        *       };
                        */

                        var visibilityLegendLabel = {
                            &quot;for&quot;: legendName,
                            &quot;attr&quot;: attr,
                            &quot;value&quot;: groupName,
                            &quot;checked&quot;: &quot;checked&quot;,
                            &quot;label&quot;: layerConfig.displayName,
                            &quot;class&quot;: &quot;eye checked&quot;,
                            &quot;featureId&quot;: featureId
                        };

                        var boundingLegendLabel = {
                            &quot;for&quot;: legendName + &quot;1&quot;,
                            &quot;attr&quot;: attr + &quot;1&quot;,
                            &quot;value&quot;: groupName,
                            &quot;checked&quot;: &quot;checked&quot;,
                            &quot;label&quot;: layerConfig.displayName,
                            &quot;class&quot;: &quot;box checked&quot;,
                            &quot;featureId&quot;: featureId
                        };

                        // legend data for current layer
                        var rowData = { &quot;imageUrl&quot;: Ramp.getSymbolForLayer(layer).imageUrl,
                            &quot;displayName&quot;: Ramp.getLayerConfig(layer.url).displayName,
                            &quot;dataLayerUUID&quot;: featureId.replace(&quot;layer_&quot;, &quot;&quot;),
                            &quot;txtMetadata&quot;: localString.txtMetadata,
                            &quot;VisibilityLegend&quot;: visibilityLegendLabel,
                            &quot;BoundingBoxLegend&quot;: boundingLegendLabel
                        };

                        /* End */

                        /* Begin legend sub row: legend for each layer */
                        var legend = layerConfig.symbology.icons;

                        var subRows = [];

                        utilDict.forEachEntry(legend, function (li) {
                            var legendKeyValue = li,
                                    cleanValue = li.replace(/-/g, &quot;&quot;),
                                    legendIcon;

                            legendIcon = legend[legendKeyValue].imageUrl;

                            var subRow = { &quot;imageUrl&quot;: legendIcon, &quot;title&quot;: localString[String.format(&quot;altFeature_{0}_Icon_{1}&quot;, featureId, cleanValue)] };

                            subRows.push(subRow);
                        });

                        var layerLegendData = {
                            &quot;layerId&quot;: layer.id,
                            &quot;rowData&quot;: rowData,
                            &quot;subRows&quot;: subRows
                        };

                        allLayerData.push(layerLegendData);
                    });

                    var templateKey = &quot;&quot;;
                    tmpl.cache = {};

                    tmpl.templates = JSON.parse(tmplHelper.stringifyTemplate(filter_row_template_json));

                    // generate the content using rowData and given template
                    section = tmpl(config.siteTemplate.filterRowTemplate, allLayerData);

                    return section;
                }
                /**
                 * Sets UI status of a layer presentation (checkbox and eye) according to the user action: select / de-select a layer.
                 * publishes event &quot;filterManager/box-visibility-toggled&quot; every time a layer status changed.
                 * There should only be one eye and one global checkbox, but
                 * we say checkbox&quot;es&quot; because jquery returns a list and it&#x27;s
                 * easier to write a function that takes a list of checkboxes
                 * than to write two functions, one to take a list and one to
                 * take an individual checkbox
                 * @method setCheckboxEvents
                 * @private
                 */
                function setCheckboxEvents() {
                    
                    var globalEyeCheckboxes,
	                    globalBoxCheckboxes,
	                    eyeCheckboxes,
	                    boxCheckboxes;

                    globalEyeCheckboxes = utilMisc.styleCheckboxes(
                        filterGlobalToggles.find(&quot;.checkbox-custom .eye + input&quot;),
                        &quot;checked&quot;, &quot;focused&quot;,
                        { &quot;checked&quot;: localString.txtHideAllFeatures, &quot;unchecked&quot;: localString.txtShowAllFeatures }
                    );

                    // Turn off the bounding boxes by default
                    globalBoxCheckboxes = utilMisc
                        .styleCheckboxes(
                            filterGlobalToggles.find(&quot;.checkbox-custom .box + input&quot;),
                            &quot;checked&quot;, &quot;focused&quot;,
                            { &quot;checked&quot;: localString.txtHideAllBounds, &quot;unchecked&quot;: localString.txtShowAllBounds })
                        .setAll(false);

                    eyeCheckboxes = utilMisc.styleCheckboxes(
                        layerList.find(&quot;.checkbox-custom .eye + input&quot;),
                        &quot;checked&quot;, &quot;focused&quot;,
                        { &quot;checked&quot;: localString.txtHideFeatures, &quot;unchecked&quot;: localString.txtShowFeatures }
                    );

                    // Turn off the bounding boxes by default
                    boxCheckboxes = utilMisc
                        .styleCheckboxes(
                            layerList.find(&quot;.checkbox-custom .box + input&quot;),
                            &quot;checked&quot;, &quot;focused&quot;,
                            { &quot;checked&quot;: localString.txtHideBounds, &quot;unchecked&quot;: localString.txtShowBounds })
                        .setAll(false);
                    /**
                     * Toggles each layers visibility when the global visibility button is clicked
                     * @method toggleGlobalEye
                     * @param {Boolean} checked The value of the global visibility button&#x27;s check status (on or off)
                     */
                    function toggleGlobalEye(checked) {
                        eyeCheckboxes.setAll(checked);

                        topic.publish(EventManager.FilterManager.GLOBAL_LAYER_VISIBILITY_TOGGLED, {
                            checked: checked
                        });
                    }
                    /**
                    * Toggles each layers boundary box display check box when the global boundary box button is clicked
                    * @method toggleGlobalBox
                    * @param {Boolean} checked The value of the global boundary box button&#x27;s check status (on or off)
                    */
                    function toggleGlobalBox(checked) {
                        boxCheckboxes.setAll(checked);

                        topic.publish(EventManager.FilterManager.GLOBAL_BOX_VISIBILITY_TOGGLED, {
                            checked: checked
                        });
                    }

                    topic.subscribe(EventManager.FilterManager.TOGGLE_GLOBAL_LAYER_VISIBILITY, function (evt) {
                        globalEyeCheckboxes.setAll(evt.visible);
                        toggleGlobalEye(evt.visible);
                    });

                    topic.subscribe(EventManager.FilterManager.TOGGLE_GLOBAL_BOX_VISIBILITY, function (evt) {
                        globalBoxCheckboxes.setAll(evt.visible);
                        toggleGlobalBox(evt.visible);
                    });

                    /* START GLOBAL &quot;EYE&quot; AND BOUNDING BOX BUTTON EVENTS */
                    globalEyeCheckboxes.getNodes().on(&quot;change&quot;, function () {
                        // True if the checkbox got selected, false otherwise
                        var checked = $(this).is(&#x27;:checked&#x27;);

                        toggleGlobalEye(checked);
                    });

                    globalBoxCheckboxes.getNodes().on(&quot;change&quot;, function () {
                        // True if the checkbox got selected, false otherwise
                        var checked = $(this).is(&#x27;:checked&#x27;);

                        toggleGlobalBox(checked);
                    });

                    /* END GLOBAL &quot;EYE&quot; AND BOUNDING BOX BUTTONS */

                    /* START INDIVIDUAL &quot;EYE&quot; AND BOUNDING BUTTON EVENTS */
                    /**
                     * Toggles the visibility button (or eye) beside a given layer in the legend. Fires the layer_visibility event.
                     * @method toggleEye
                     * @param {Boolean} checked The check status of the visibility button next to the target layer (on or off)
                     * @param {Object} node The legend item representing the target layer
                     */
                    function toggleEye(checked, node) {
                        // Figure out whether or not all the checkboxes are selected
                        var allChecked = dojoArray.every(eyeCheckboxes.getNodes(), function (checkbox) {
                            return $(checkbox).is(&#x27;:checked&#x27;);
                        });

                        globalEyeCheckboxes.setAll(allChecked);

                        // True if the checkbox got selected, false otherwise
                        topic.publish(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, {
                            checked: checked,
                            node: node[0]
                        });
                    }
                    /**
                    * Toggles the boundary box button beside a given layer in the legend. Fires the box_visibility event.
                    * @method toggleBox
                    * @param {Boolean} checked The check status of the boundary box button next to the target layer (on or off)
                    * @param {Object} node The legend item representing the target layer
                    */
                    function toggleBox(checked, node) {
                        // Figure out whether or not all the checkboxes are selected
                        var allChecked = dojoArray.every(boxCheckboxes.getNodes(), function (checkbox) {
                            return $(checkbox).is(&#x27;:checked&#x27;);
                        });

                        globalBoxCheckboxes.setAll(allChecked);

                        topic.publish(EventManager.FilterManager.BOX_VISIBILITY_TOGGLED, {
                            checked: checked,
                            node: node[0]
                        });
                    }

                    topic.subscribe(EventManager.FilterManager.TOGGLE_LAYER_VISIBILITY, function (evt) {
                        // Set the checkboxes visually, checkboxes with an id in evt.layerIds gets
                        // turned on, the rest gets turned off
                        eyeCheckboxes.setState(function (checkbox) {
                            var layerId = $(checkbox).findInputLabel().data(&quot;layer-id&quot;);
                            return evt.layerIds.contains(layerId);
                        });

                        dojoArray.forEach(eyeCheckboxes.getNodes(), function (checkbox) {
                            checkbox = $(checkbox);
                            var layerId = checkbox.findInputLabel().data(&quot;layer-id&quot;);
                            toggleEye(evt.layerIds.contains(layerId), checkbox);
                        });
                    });

                    topic.subscribe(EventManager.FilterManager.TOGGLE_BOX_VISIBILITY, function (evt) {
                        // Set the checkboxes visually, checkboxes with an id in evt.layerIds gets
                        // turned on, the rest gets turned off
                        boxCheckboxes.setState(function (checkbox) {
                            var layerId = $(checkbox).findInputLabel().data(&quot;layer-id&quot;);
                            return evt.layerIds.contains(layerId);
                        });

                        dojoArray.forEach(boxCheckboxes.getNodes(), function (checkbox) {
                            checkbox = $(checkbox);
                            var layerId = checkbox.findInputLabel().data(&quot;layer-id&quot;);
                            toggleBox(evt.layerIds.contains(layerId), checkbox);
                        });
                    });

                    // Event handling for individual &quot;eye&quot; and &quot;box&quot; toggle
                    eyeCheckboxes.getNodes().on(&quot;change&quot;, function () {
                        var node = $(this),
		                    checked = node.is(&#x27;:checked&#x27;);

                        toggleEye(checked, node);
                    });

                    boxCheckboxes.getNodes().on(&quot;change&quot;, function () {
                        var node = $(this),
                        // True if the checkbox got selected, false otherwise
		                    checked = node.is(&#x27;:checked&#x27;);

                        toggleBox(checked, node);
                    });
                    /* END INDIVIDUAL &quot;EYE&quot; AND BOUNDING BUTTON EVENTS */
                }
                /**
                 * initialize a tooltip for each layer, using the layer name.
                 * @method initTooltips
                 * @private
                 */
                function initTooltips() {
                   
                    popupManager.registerPopup(layerList, &quot;hoverIntent&quot;,
                        function () {
                            if (this.target.attr(&quot;title&quot;)) {
                                if (this.target.isOverflowed()) {
                                    this.target.tooltipster({ theme: &#x27;.tooltipster-dark&#x27; }).tooltipster(&quot;show&quot;);
                                } else {
                                    this.target.removeAttr(&quot;title&quot;);
                                }
                            }
                        },
                        {
                            handleSelector: &quot;.layer-name span&quot;,
                            useAria: false,
                            timeout: 500
                        }
                    );
                }
                /**
                 * Adjusts UI layout according to a layer event.
                 * @method setButtonEvents
                 * @private
                 */
                function setButtonEvents() {
                   
                    var expandAllButton = filterGlobalToggles.find(&quot;.global-button&quot;),
                        expandAllPopupHandle,
                        expandNodes = layerList.find(&quot;.layerList-container:hidden&quot;),
                        expandButtons = layerList.find(&quot;button.legend-button&quot;);
                    /**
                * Changes the width of the layers pane to accommodate for the scrollbar if it&#x27;s needed.
                * @method adjustPaneWidth
                * @private
                */
                    function adjustPaneWidth() {
                       
                        utilMisc.adjustWidthForSrollbar(layerList, [filterGlobalToggles]);
                    }
                    /**
                *  Changes the state of the expand all control if all the nodes are expanded.
                * @method adjustExpandAllButtonState
                * @private
                */
                    function adjustExpandAllButtonState() {
                        
                        var count = expandNodes.length,
                            hiddenCount = expandNodes.filter(&quot;:hidden&quot;).length;

                        if (hiddenCount === 0) {
                            expandAllPopupHandle.open();
                        } else if (hiddenCount === count) {
                            expandAllPopupHandle.close();
                        }
                    }

                    expandButtons.map(function () {
                        var handle = $(this),
                            target = handle.parents(&quot;fieldset&quot;).find(&quot;&gt; .layerList-container&quot;);

                        popupManager.registerPopup(handle, &quot;state-expanded&quot;, target, &quot;click&quot;,
                            function (d) {
                                target.slideToggle(400, function () {
                                    adjustPaneWidth();
                                    adjustExpandAllButtonState();
                                    d.resolve();
                                });
                            },
                            &quot;same&quot;
                        );
                    });

                    expandAllPopupHandle = popupManager.registerPopup(expandAllButton, &quot;state-expanded&quot;, expandNodes, &quot;click&quot;,
                        function (d) {
                            expandNodes.slideDown(400, function () {
                                expandButtons.addClass(&quot;state-expanded&quot;);

                                adjustPaneWidth();
                                d.resolve();
                            });
                        },
                        function (d) {
                            expandNodes.slideUp(400, function () {
                                expandButtons.removeClass(&quot;state-expanded&quot;);
                                $(&quot;#tabs1_1-parent&quot;).scrollTop(0);

                                adjustPaneWidth();
                                d.resolve();
                            });
                        });

                    // metadata buttons
                    // to be changed...
                    layerList.find(&quot;legend button.metadata-button&quot;).on(&quot;click&quot;, function () {
                        var node = $(this).parents(&quot;legend&quot;);

                        if (!node.hasClass(&quot;selected-row&quot;)) {
                            //var guid = $(this).data(&quot;guid&quot;) || $(this).data(&quot;guid&quot;, utilMisc.guid()).data(&quot;guid&quot;);
                            var guid = $(this).data(&quot;layer-uuid&quot;),
                                metadataUrl;

                            topic.publish(EventManager.GUI.SUBPANEL_OPEN, {
                                panelName: localString.txtMetadata,
                                title: node.find(&quot;.layer-name span&quot;).text(), // + &quot; &quot; + guid,
                                content: null,
                                target: node.find(&quot;.layer-details&quot;),
                                origin: &quot;filterManager&quot;,
                                guid: guid,
                                doOnOpen: function () { node.addClass(&quot;selected-row&quot;); },
                                doOnHide: function () { layerList.find(&quot;.selected-row&quot;).removeClass(&quot;selected-row&quot;); }
                            });

                            metadataUrl = &quot;assets/metadata/&quot; + guid + &quot;.xml&quot;;

                            utilMisc.transformXML(metadataUrl, &quot;assets/metadata/xstyle_default_&quot; + config.lang + &quot;.xsl&quot;,
                                function (data) {
                                    topic.publish(EventManager.GUI.SUBPANEL_OPEN, {
                                        content: $(data),
                                        origin: &quot;filterManager&quot;,
                                        update: true,
                                        guid: guid
                                    });
                                });
                        } else {
                            topic.publish(EventManager.GUI.SUBPANEL_CLOSE, { origin: &quot;filterManager&quot; });
                        }
                    });
                }
                /**
                * Adjusts filter style according to the scroll action on the layers.
                * @method initScrollListeners
                * @private
                */
                function initScrollListeners() {
                    
                    layerList.scroll(function () {
                        var currentScroll = layerList.scrollTop();
                        if (currentScroll === 0) {
                            filterGlobalToggles.removeClass(&quot;scroll&quot;);
                        } else {
                            filterGlobalToggles.addClass(&quot;scroll&quot;);
                        }
                    });
                }

                return {
                    init: function () {
                        var globalCheckboxes = generateGlobalCheckboxes(),
                            filterCheckboxes = generateFilterCheckboxes(),
                            sectionNode = $(&quot;#searchMapSectionBody&quot;),
                            section;

                        section = String.format(filter_manager_Template,
                            globalCheckboxes,
                            filterCheckboxes);

                        // fade out the loading animation
                        sectionNode.addClass(&#x27;animated fadeOut&#x27;);
                        window.setTimeout(
                            function () {
                                sectionNode
							        .empty().append(section)
							        .removeClass(&quot;fadeOut&quot;)
							        .addClass(&#x27;animated fadeIn&#x27;);

                                // remove the animating css class
                                window.setTimeout(function () { sectionNode.removeClass(&#x27;animated fadeIn&#x27;); }, 300);

                                layerList = $(&quot;#layerList&quot;);
                                if (layerList.find(&quot;&gt; li&quot;).length &gt; 1) {
                                    layerList.sortable(
                                        {
                                            axis: &quot;y&quot;,
                                            handle: &quot;.sort-handle&quot;,
                                            placeholder: &quot;sortable-placeholder&quot;,
                                            update: function (event, ui) {
                                                var layerId = ui.item[0].id,
                                                    index = dojoArray.indexOf($(&quot;#layerList&quot;).sortable(&quot;toArray&quot;), layerId);

                                                topic.publish(EventManager.GUI.SUBPANEL_CLOSE, { origin: &quot;rampPopup,datagrid&quot; });

                                                topic.publish(EventManager.FilterManager.SELECTION_CHANGED, {
                                                    id: layerId,
                                                    index: index
                                                });
                                            }
                                        }
                                    );
                                }
                                filterGlobalToggles = $(&#x27;#filterGlobalToggles&#x27;);

                                setCheckboxEvents();

                                initTooltips();

                                setButtonEvents();

                                initScrollListeners();

                                // ui initialization complets
                                console.log(EventManager.FilterManager.UI_COMPLETE);
                                topic.publish(EventManager.FilterManager.UI_COMPLETE);
                            },
					        300
                        );
                    }
                };
            } ());

        /**
        * Initiates a listener to handle tab deselected event
        *
        * @method initListeners
        * @private
        */
        function initListeners() {
            topic.subscribe(EventManager.GUI.TAB_DESELECTED, function (arg) {
                if (arg.tabName === &quot;filterManager&quot;) {
                    topic.publish(EventManager.GUI.SUBPANEL_CLOSE, { origin: &quot;filterManager&quot; });
                }
            });
        }

        return {
            /**
             * Reads the application configuration and creates the legend and filter management widget
             * @method init
             * @constructor
             */
            init: function () {
               
                // Convenience config objects
                config = GlobalStorage.config;
                localString = GlobalStorage.config.stringResources;
               
                localString.txtShowFeatures = &quot;Show {0}&quot;;
                localString.txtHideFeatures = &quot;Hide {0}&quot;;
                localString.txtShowAllFeatures = &quot;Show All&quot;;
                localString.txtHideAllFeatures = &quot;Hide All&quot;;

                localString.txtShowBounds = &quot;Show Bounds of {0}&quot;;
                localString.txtHideBounds = &quot;Hide Bounds of {0}&quot;;
                localString.txtShowAllBounds = &quot;Show All Bounds&quot;;
                localString.txtHideAllBounds = &quot;Hide All Bounds&quot;;

                initListeners();

                ui.init();
            }, 
            /**
             * Queries all map points on a given feature layer and returns their attributes
             * @method _getFeatures
             * @param {Object} fl A feature layer to query
             * @return {Object} An array of attributes from the designated feature layer
             */
            _getFeatures: function (fl) {
                //do a query on ALL the map points.
                var queryTask = new EsriQuery();
                queryTask.returnGeometry = false; //only return attributes
                queryTask.maxAllowableOffset = 1000;
                //query.outFields = outFieldsList;  //note: this list is overridden by fields in featurelayer constructor
                queryTask.where = fl.objectIdField + &quot;&gt;0&quot;;

                return fl.queryFeatures(queryTask);
            },
            /**
             * Grabs all distinct values of the given field from a featureLayer.
             * @method _getField
             * @param {Object} fl A feature layer to query
             * @param {String} The field (or column) to query in the feature layer 
             * @return {Object} deferred A deferred object which will resolve to an array of unique values
             */           
            _getField: function (fl, field) {
                var deferred = new Deferred();

                this._getFeatures(fl).then(function (featureSet) {
                    deferred.resolve(dojoArray.map(featureSet.features, function (feature) {
                        return feature.attributes[field];
                    }));
                });

                return deferred.promise;
            }
        };
    });
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
