<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>javascript\src\RAMP\Modules\datagrid.js - RAMP GIS Viewer</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..\..\..\assets\images\arctic_fox_logo_200x100.png" title="RAMP GIS Viewer"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.8-0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Array.html">Array</a></li>
            
                <li><a href="../classes/BaseMapSelector.html">BaseMapSelector</a></li>
            
                <li><a href="../classes/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../classes/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../classes/CheckboxWrapper.html">CheckboxWrapper</a></li>
            
                <li><a href="../classes/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../classes/DatagridClickHandler.html">DatagridClickHandler</a></li>
            
                <li><a href="../classes/Decorator.html">Decorator</a></li>
            
                <li><a href="../classes/Dictionary.html">Dictionary</a></li>
            
                <li><a href="../classes/EventManager.html">EventManager</a></li>
            
                <li><a href="../classes/FeatureClickHandler.html">FeatureClickHandler</a></li>
            
                <li><a href="../classes/FeatureHighlighter.html">FeatureHighlighter</a></li>
            
                <li><a href="../classes/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../classes/FunctionMangler.html">FunctionMangler</a></li>
            
                <li><a href="../classes/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../classes/GraphicExtension.html">GraphicExtension</a></li>
            
                <li><a href="../classes/GUI.html">GUI</a></li>
            
                <li><a href="../classes/Map.html">Map</a></li>
            
                <li><a href="../classes/Maptips.html">Maptips</a></li>
            
                <li><a href="../classes/Navigation.html">Navigation</a></li>
            
                <li><a href="../classes/Popup.html">Popup</a></li>
            
                <li><a href="../classes/PopupBase.html">PopupBase</a></li>
            
                <li><a href="../classes/PopupBaseSettings.html">PopupBaseSettings</a></li>
            
                <li><a href="../classes/PopupManager.html">PopupManager</a></li>
            
                <li><a href="../classes/Prototype.html">Prototype</a></li>
            
                <li><a href="../classes/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../classes/RAMP.html">RAMP</a></li>
            
                <li><a href="../classes/RampMap.html">RampMap</a></li>
            
                <li><a href="../classes/RAMPStarter.html">RAMPStarter</a></li>
            
                <li><a href="../classes/SidePanel.html">SidePanel</a></li>
            
                <li><a href="../classes/SubPanel.html">SubPanel</a></li>
            
                <li><a href="../classes/SubPanelSettings.html">SubPanelSettings</a></li>
            
                <li><a href="../classes/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../classes/Url.html">Url</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../modules/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../modules/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../modules/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../modules/Map.html">Map</a></li>
            
                <li><a href="../modules/Maptips.html">Maptips</a></li>
            
                <li><a href="../modules/Navigation.html">Navigation</a></li>
            
                <li><a href="../modules/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../modules/RAMP.html">RAMP</a></li>
            
                <li><a href="../modules/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/Utils.html">Utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: javascript\src\RAMP\Modules\datagrid.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿/**
* Datagrid submodule.
*
* @module RAMP
* @submodule Datagrid
* @main Datagrid
*/

/**
* The Datagrid class represents the side bar table shown next to the map. The data grid displays all map objects in a text format and allows the user to see more 
* details (same as clicking the map object) and navigate to the object. This class create the UI panel, events, and event-handles for the data grid conatiner.
*
* @class Datagrid
* @static
* @uses dojo/_base/declare
* @uses dojo/_base/lang
* @uses dojo/query
* @uses dojo/_base/array
* @uses dojo/dom-class
* @uses dojo/dom-attr
* @uses dojo/dom-construct
* @uses dojo/topic
* @uses dojo/on
* @uses esri/layers/FeatureLayer
* @uses esri/tasks/query
* @uses Ramp
* @uses GraphicExtension
* @uses GlobalStorage
* @uses Gui
* @uses DatagridClickHandler
* @uses Util
* @uses Array
* @uses Dictionary
* @uses PopupManager
* @uses TmplHelper
*/

/*global define, window, tmpl */
/*jslint white: true */

define([
/* Dojo */
    &quot;dojo/_base/declare&quot;, &quot;dojo/_base/lang&quot;, &quot;dojo/query&quot;, &quot;dojo/_base/array&quot;, &quot;dojo/dom-class&quot;,
    &quot;dojo/dom-attr&quot;, &quot;dojo/dom-construct&quot;, &quot;dojo/topic&quot;, &quot;dojo/on&quot;,

/* Text */
     &quot;dojo/text!./templates/datagrid_template.json&quot;,
     &quot;dojo/text!./templates/extended_datagrid_template.json&quot;,

// Esri
        &quot;esri/layers/FeatureLayer&quot;, &quot;esri/tasks/query&quot;,

// Ramp
        &quot;ramp/ramp&quot;, &quot;ramp/graphicExtension&quot;, &quot;ramp/globalStorage&quot;, &quot;ramp/datagridClickHandler&quot;, &quot;ramp/map&quot;,
        &quot;ramp/eventManager&quot;,

// Util
         &quot;utils/util&quot;, &quot;utils/array&quot;, &quot;utils/dictionary&quot;, &quot;utils/popupManager&quot;, &quot;utils/tmplHelper&quot;],

    function (
    // Dojo
        declare, lang, dojoQuery, dojoArray, domClass, domAttr,
        domConstruct, topic, dojoOn,

    //Text
        data_grid_template_json,
        extended_datagrid_template_json,

    // Esri
        FeatureLayer, EsriQuery,

    // Ramp
        Ramp, GraphicExtension, GlobalStorage, DatagridClickHandler, RampMap, EventManager,

    // Util
        utilMisc, utilArray, utilDict, popupManager, tmplHelper) {
        &quot;use strict&quot;;

        var config,
            layerConfig,
            gridConfig,

        // The jquery table
            oTable,

        // The JQuery Object representing the grid
            jqgrid,

        // A Boolean used to keep track of whether or not the grid should apply an
        // extent filter when the datagrid gets selected
            extentFilterExpired = true,

            zoomToGraphic,

            lastExtent,

        // Stores functions used to sort the datagrid
            sortFcns = {},

        // The name of the current sort function
            currentSortFcn = &quot;ascending&quot;,

        // Name of the attribute used to store the oid
        // in the details and zoomTo buttons
            featureOidField = &quot;feature-oid&quot;,

        // Name of the attribute used to store the feature url
        // in the details and zoomTo buttons
            featureUrlField = &quot;feature-url&quot;,

            ui = (function () {
                /**
                * Creates a data grid row that has the following features:
                * highlight for a give graphic
                * un-highlight
                * scroll to for a give graphic
                *
                * @method createRowPrototype
                * @private
                * @param cssClass {String} the style that highlights the row.
                * @return {Object} an object containing features of a data grid row
                */

                function createRowPrototype(cssClass) {
                    var index = -1,
                        node = null;

                    /**
                    * Returns the index of the given graphic object in the data grid
                    *
                    * @method getGraphicIndex
                    * @param {Object} graphic
                    * @private
                    */
                    function getGraphicIndex(graphic) {
                        var targetData = getDataObject(graphic),
                            data = jqgrid.dataTable().fnGetData();

                        return utilArray.binaryIndexOf(data, function (entry) {
                            return sortFcns[currentSortFcn](entry, targetData);
                        });
                    }

                    return {
                        graphic: null,

                        focusedButton: null,

                        /**
                        * Navigate to the page the row is in and scroll to it. Returns true
                        * if the row exists in the data grid, false otherwise.
                        *
                        * @method navigateToRow
                        * @return {Boolean} A value indicating is the navigation is sucessful
                        * @private
                        */
                        navigateToRow: function () {
                            if (index !== -1) {
                                // Figure out which page the entry is in and navigate to that page
                                var page = Math.floor(index / gridConfig.rowsPerPage);
                                jqgrid.dataTable().fnPageChange(page);
                                jqgridTableWrapper.scrollTo(node, 300, {
                                    axis: &quot;y&quot;,
                                    offset: {
                                        left: 0,
                                        top: -node.height() * 1.5
                                    }
                                });

                                return true;
                            }
                            return false;
                        },

                        /**
                        * Finds a row node corresponding to the given graphic object.
                        *
                        * @method update
                        * @private
                        * @return {{node: jObject, page: number}} A row node that displays graphic information. If none found, returns an object with empty jNode.
                        */
                        update: function () {
                            if (this.graphic) {
                                index = getGraphicIndex(this.graphic);
                                if (index !== -1) {
                                    node = $(jqgrid.dataTable().fnGetNodes(index));
                                }
                            } else {
                                index = -1;
                            }
                        },
                        /**
                       * Finds a row node corresponding to the given graphic object.
                       *
                       * @method getNode
                       * @private
                       * @return {{node: jObject, page: number}} A row node that displays graphic information. If none found, returns an object with empty jNode.
                       */
                        getNode: function () {
                            this.update();
                            return node;
                        },
                        /**
                     * Highlights the the given graphic object using the specified cssClass.
                     *
                     * @method activate
                     * @private
                     */
                        activate: function () {
                            if (this.graphic) {
                                this.getNode().addClass(cssClass);

                                if (this.focusedButton) {
                                    node.find(this.focusedButton).focus();
                                    this.focusedButton = null;
                                }
                            }
                        },
                     /**
                     * Removes a specified cssClass from a given graphic object in the data grid
                     *
                     * @method deactivate
                     * @private
                     */
                        deactivate: function () {
                            
                            if (this.graphic) {
                                this.getNode().removeClass(cssClass);
                                this.graphic = null;
                            }
                        }
                    };
                }

                var highlightRow = createRowPrototype(&quot;selected-row&quot;),
                    zoomlightRow = createRowPrototype(&quot;highlighted-row&quot;),

                    sectionNode,

                    datagridStatusLine,
                    datagridGlobalToggles,
                    jqgridTableWrapper,

                    _isReady = false; // indicates if the UI has fully rendered
                /**
                     * Generates a data grid row data with a checkbox to be used in template
                     *
                     * @method generateToggleButtonDataForTemplate
                     * @private
                     * @return {String} the generated row data object.
                     */
                function generateToggleButtonDataForTemplate() {
                    
                    // TODO: if no more modification is needed, this can be omitted and merged in the higher level.
                    // create object for template
                    // TODO: JKW
                    // Note, the following object is for passing to the template, properties
                    // were guessed. Need to add more detail later on. Empty values were provided
                    // eg. there were value of &quot;&quot; assigned to the toggle button template, in the code
                    // provided. A temporary property name &quot;attribute&quot; is used. Not sure if this will be
                    // used by ECDMP, therefore, leave the empty value in the template
                    var toggleButtonData = { &quot;buttonLabel&quot;: &quot;Sort&quot;, &quot;classAddition&quot;: &quot;font-medium global-button&quot;, &quot;someAttribute&quot;: &quot;&quot; };

                    return toggleButtonData;
                }
                /**
                     * Creates a Data table based on the grid configuration specified in the application config object. See http://www.datatables.net/usage/columns  for addition information on config parameters.
                     *
                     * @method createDatatable
                     * @private
                     */
                function createDatatable() {
                    

                    var jqg_layout = dojoArray.map(gridConfig.gridColumns, function (column, i) {
                        return {
                            &quot;sTitle&quot;: column.title,
                            &quot;sWidth&quot;: column.width,
                            &quot;sType&quot;: column.sortType,
                            &quot;sClass&quot;: column.alignment ? &quot;&quot; : &quot;center&quot;,
                            &quot;mRender&quot;: undefined,
                            &quot;aTargets&quot;: [i]
                        };
                    });

                    oTable = jqgrid.dataTable({
                        &quot;bSort&quot;: false, // Disable sorting since we&#x27;re sorting the array ourselves
                        &quot;sDom&quot;: &#x27;&lt;&quot;jqgrid_table_wrapper&quot;t&gt;&lt;&quot;status-line &quot;p&gt;&#x27;,
                        &quot;aoColumns&quot;: jqg_layout,
                        &quot;bFilter&quot;: false,
                        &quot;bInfo&quot;: false,
                        &quot;bLengthChange&quot;: false,
                        &quot;bPaginate&quot;: true,
                        &quot;iDisplayLength&quot;: gridConfig.rowsPerPage,
                        &quot;sPaginationType&quot;: &quot;ramp&quot;,
                        &quot;bDestroy&quot;: true,
                        &quot;oLanguage&quot;: config.gridstrings,
                        &quot;bDeferRender&quot;: true,
                        &quot;fnDrawCallback&quot;: function () {
                            topic.publish(EventManager.Datagrid.DRAW_COMPLETE);
                        }
                    }).on(&quot;page&quot;, function () {
                        topic.publish(EventManager.GUI.SUBPANEL_DOCK, { origin: &quot;datagrid&quot; });

                        console.log(&quot;subPanleDock&quot;);
                    });

                    jqgridTableWrapper = sectionNode.find(&quot;.jqgrid_table_wrapper&quot;);
                }
                /**
                     * Initialize tooltips for the data grid
                     *
                     * @method initTooltips
                     * @private
                     */
                function initTooltips() {
                    popupManager.registerPopup(sectionNode, &quot;hoverIntent&quot;,
                        function () {
                            if (this.target.attr(&quot;title&quot;)) {
                                if (this.target.isOverflowed()) {
                                    this.target.tooltipster({ theme: &#x27;.tooltipster-dark&#x27; }).tooltipster(&quot;show&quot;);
                                } else {
                                    this.target.removeAttr(&quot;title&quot;);
                                }
                            }
                        },
                        {
                            handleSelector: &quot;.point-name, .category-name&quot;,
                            useAria: false,
                            timeout: 500
                        }
                    );
                }
                /**
                     * Adds event-handling for buttons inside the data grid&#x27;s row elements (i.e &#x27;Details&#x27;, &#x27;Zoom To&#x27; buttons)
                     *
                     * @method setButtonEvents
                     * @private
                     */
                function setButtonEvents() {

                    sectionNode.on(&quot;click&quot;, &quot;button.details&quot;, function () {
                        var buttonNode = $(this),
                            node = buttonNode.parents(&quot;.record-row&quot;).parent().parent();  //TODO: replace with better selector

                        highlightRow.focusedButton = &quot;button.details&quot;;

                        if (highlightRow.graphic &amp;&amp; highlightRow.getNode()[0] === node[0]) {
                            DatagridClickHandler.onDetailDeselect();
                        } else {
                            var graphic = getGraphicFromButton(buttonNode);

                            DatagridClickHandler.onDetailSelect(buttonNode, graphic);
                        }
                    });

                    // Event handling for &quot;Zoom To&quot; button
                    sectionNode.on(&quot;click&quot;, &quot;button.zoomto&quot;, function (evt) {
                        var zoomNode = $(this);

                        zoomlightRow.focusedButton = &quot;button.zoomto&quot;;

                        // Zoom To
                        if (zoomNode.text() === config.stringResources.txtGrid_zoomTo) {
                            handleGridEvent(evt, function () {
                                zoomToGraphic = getGraphicFromButton(zoomNode);

                                //store the current extent, then zoom to point.
                                lastExtent = RampMap.getMap().extent.clone();

                                DatagridClickHandler.onZoomTo(RampMap.getMap().extent.clone(), zoomToGraphic);

                                // Update &quot;zoom back&quot; text after the extent change, if we update it
                                // before the extent change, it won&#x27;t work since the datagrid gets
                                // repopulated after an extent change
                                utilMisc.subscribeOnce(EventManager.Datagrid.EXTENT_FILTER_END, function () {
                                    // Find the first node with the same oid, featureUrl
                                    var newNode = $(String.format(&quot;button.zoomto[data-{0}=&#x27;{1}&#x27;][data-{2}=&#x27;{3}&#x27;]:eq(0)&quot;,
                                                    featureOidField, GraphicExtension.getOid(zoomToGraphic),
                                                    featureUrlField, zoomToGraphic.getLayer().url));
                                    newNode.text(config.stringResources.txtGrid_zoomBack);
                                });
                            });
                        } else { // Zoom back
                            DatagridClickHandler.onZoomBack(zoomToGraphic);
                            zoomNode.text(config.stringResources.txtGrid_zoomTo);
                        }
                    });

                    sectionNode.on(&quot;click&quot;, &quot;button.global-button&quot;, function () {
                        var buttonNode = $(this);

                        if (currentSortFcn === &quot;ascending&quot;) {
                            buttonNode.addClass(&quot;state-expanded&quot;);
                            currentSortFcn = &quot;descending&quot;;
                        } else {
                            buttonNode.removeClass(&quot;state-expanded&quot;);
                            currentSortFcn = &quot;ascending&quot;;
                        }
                        applyExtentFilter();
                    });
                    //Adds an event trigger for the expansion of the data grid control
                    sectionNode.on(&quot;click&quot;, &quot;button.expand&quot;, function () {
                        console.log(&quot;grid expanded!&quot;);
                        topic.publish(&quot;gui/grid/expand&quot;);
                    });
                    popupManager.registerPopup(sectionNode, &quot;hover, focus&quot;,
                        function (d) {
                            this.target.removeClass(&quot;wb-invisible&quot;);
                            d.resolve();
                        },
                        {
                            handleSelector: &quot;tr&quot;,

                            targetSelector: &quot;.record-controls&quot;,

                            closeHandler: function (d) {
                                this.target.addClass(&quot;wb-invisible&quot;);
                                d.resolve();
                            },

                            activeClass: &quot;background-light&quot;,
                            useAria: false
                        }
                    );
                }
                /**
                     * Apply&#x27;s or removes the scrollbar from the data grid based on the height of its container.
                     *
                     * @method initScrollListeners
                     * @private
                     */
                function initScrollListeners() {
                   
                    jqgridTableWrapper.scroll(function () {
                        var currentScroll = jqgridTableWrapper.scrollTop();
                        if (currentScroll === 0) {
                            datagridGlobalToggles.removeClass(&quot;scroll&quot;);
                        } else {
                            datagridGlobalToggles.addClass(&quot;scroll&quot;);
                        }
                    });

                    jqgridTableWrapper.scroll(function () {
                        var currentScroll = jqgridTableWrapper.scrollTop() + jqgridTableWrapper.outerHeight() - datagridStatusLine.outerHeight();

                        if (currentScroll - datagridGlobalToggles.outerHeight() === jqgrid.height()) {
                            datagridStatusLine.removeClass(&quot;scroll&quot;);
                        } else {
                            datagridStatusLine.addClass(&quot;scroll&quot;);
                        }
                    });
                }
                /**
                    * Highlights the row according to the graphic stored in the event. Sets the hightlightRow variable to the graphic object inside the sent event
                    *
                    * @method highlightrowShow
                    * @private
                    * @param {Object} event A thrown event that contains a graphic object inside the grid
                    */
                function highlightrowShow(event) {
                    highlightrowHide();

                    highlightRow.graphic = event.graphic;

                    if (event.scroll) {
                        ui.activateRows();
                        //applyExtentFilter();
                    }
                }
                /**
                    * Un-highlights the row that is currently highlighted
                    *
                    * @method highlightrowHide
                    * @private
                    */
                function highlightrowHide() {
                    highlightRow.deactivate();

                    DatagridClickHandler.onZoomCancel();
                }
                /**
                    * Stores the graphic in the given event in the variable zoomlightRow
                    *
                    * @method zoomlightrowShow
                    * @private
                    * @param {Object} event A thrown event that contains a graphic object inside the grid
                    */
                function zoomlightrowShow(event) {
                     zoomlightRow.graphic = event.graphic;
                }
                /**
                    * De-activiates the row stored in zoomlightRow
                    *
                    * @method zoomlightrowHide
                    * @private
                    */
                function zoomlightrowHide() {
                    zoomlightRow.deactivate();
                }
                /**
                 * Registers event handlers for following events:
                 * datagrid/highlightrow-show (!!2 handlers for this event!!)
                 * datagrid/zoomlightrow-show
                 * datagrid/zoomlightrow-hide
                 * @method initUIListeners
                 * @private
                 */
                function initUIListeners() {
                    topic.subscribe(EventManager.Datagrid.HIGHLIGHTROW_SHOW, highlightrowShow);

                    topic.subscribe(EventManager.Datagrid.HIGHLIGHTROW_HIDE, highlightrowHide);

                    topic.subscribe(EventManager.Datagrid.ZOOMLIGHTROW_SHOW, zoomlightrowShow);

                    topic.subscribe(EventManager.Datagrid.ZOOMLIGHTROW_HIDE, zoomlightrowHide);
                }

                return {
                    /**
                     * The constructor method for the data grid. Adds the grid&#x27;s panel to the UI, adds the data rows, and creates all event triggers
                     * 
                     * @method init
                     * @constructor
                     * 
                     */
                    init: utilMisc.once(
                        function () {
                            // using template to generate global checkboxes
                            var globalCheckBoxesData = generateToggleButtonDataForTemplate();
                            var templateData = { &quot;buttons&quot;: globalCheckBoxesData, &quot;tableId&quot;: &quot;jqgrid&quot;, &quot;tableCss&quot;: &quot;display table-condensed table-simplify&quot; };
                            var section;
                            var templateKey = &quot;&quot;;
                            tmpl.cache = {};

                            templateKey = &quot;datagrid_manager_Template&quot;; // Ramp.getLayerConfig(layerUrl).mapTipSettings.anchorTemplate;
                            tmpl.templates = JSON.parse(tmplHelper.stringifyTemplate(data_grid_template_json));

                            // generate the content using rowData and given template
                            section = tmpl(templateKey, templateData);

                            sectionNode = $(&quot;#gridpane&quot;);

                            // fade out the loading animation
                            sectionNode.addClass(&#x27;animated fadeOut&#x27;);
                            window.setTimeout(
                                function () {
                                    jqgrid = sectionNode
                                        .empty().append(section)
                                        .find(&quot;table&quot;);

                                    createDatatable();

                                    sectionNode
                                            .removeClass(&quot;fadeOut&quot;)
							                .addClass(&#x27;animated fadeIn&#x27;);

                                    datagridGlobalToggles = sectionNode.find(&#x27;#datagridGlobalToggles&#x27;);
                                    datagridStatusLine = sectionNode.find(&#x27;.status-line&#x27;);

                                    initTooltips();
                                    setButtonEvents();
                                    initScrollListeners();
                                    initUIListeners();

                                    //add button role to sortable cols
                                    //dojoQuery(&quot;.sorting&quot;).attr(&quot;role&quot;, &quot;button&quot;);

                                    //remove alert role from table body
                                    dojoQuery(&quot;tbody&quot;).removeAttr(&quot;role&quot;);

                                    _isReady = true;
                                    applyExtentFilter();

                                    window.setTimeout(function () { sectionNode.removeClass(&#x27;animated fadeIn&#x27;); }, 400);
                                },
                                300
                            );
                        }
                    ),
                    /**
                     * Indicates that the Data grid is fully rendered
                     * @method isReady
                     * @returns {Boolean} A flag indicating the render status of the data grid
                     */
                    isReady: function () {
                        return _isReady;
                    },

                    /**
                    * Removes the animating CSS class to prevent flickering
                    *
                    * @method onHide
                    * @private
                    */
                    onHide: utilMisc.once(
                        function () {
                            sectionNode.removeClass(&#x27;animated fadeIn&#x27;);
                        }
                    ),

                    /**
                    * Adjusts the width of the data grid panel to accommodate the scrollbar.
                    *
                    * @method adjustPanelWidth
                    */
                    adjustPanelWidth: function () {
                        utilMisc.adjustWidthForSrollbar(jqgridTableWrapper, [datagridGlobalToggles, datagridStatusLine]);
                    },
                    /**
                    * Navigates the grid to a row. Based on the following precedent: 1. User selected point, 2. Highlighted row, 3. zoomed row, 4. first row in the grid.
                    *
                    * @method activateRows
                    */
                    activateRows: function () {
                        // If there was previously a selected point,
                        // navigate to the correct page and highlight it in the data grid
                        highlightRow.update();
                        zoomlightRow.update();

                        // Scroll to the highlighted row first, if it fails,
                        // scroll to the zoomed row
                        if (!highlightRow.navigateToRow()) {
                            zoomlightRow.navigateToRow();
                        }

                        // set the focus on the first button in the data grid
                        // is not a really good idea to just move focus around
                        //jqgrid.dataTable().find(&quot;button:first&quot;).focus();

                        zoomlightRow.activate();
                        highlightRow.activate();

                        this.capturePanel();
                    },
                    /**
                     * publishes the subPanel_Capture event to the GUI class
                     * @method capturePanel
                     */
                    capturePanel: function () {
                        if (highlightRow.graphic) {
                            topic.publish(EventManager.GUI.SUBPANEL_CAPTURE, {
                                target: highlightRow.getNode().find(&quot;.record-controls&quot;),
                                consumeOrigin: &quot;datagrid&quot;,
                                origin: &quot;datagrid&quot;
                            });
                        }
                    }
                };
            } ());

        /**
        * Returns the config Object for the given featureLayerUrl
        *
        * @method getGridConfig
        * @param {String} url
        * @return {Object} grid config
        */
        function getGridConfig(url) {
            return Ramp.getLayerConfig(url).datagrid;
        }

        /**
        * A handler that handlers the Enter key press and Click mouse event of the data grid.
        * It is actually a binder that binds the key / mouse event to a handler specified.
        * This is wired up to grid cells in the bootstrapper to achieve click/keypress functions
        *
        * @method handleGridEvent
        * @private
        * @param {Event} e the event object
        * @param {Function} fcn the callback function
        */
        function handleGridEvent(e, callback) {
            if ((e.type === &quot;keypress&quot; &amp;&amp; e.keyCode === 13) || e.type === &quot;click&quot;) {
                callback();
                //Ramp.setHTML(oid); // just update info hit
            }
        } 
        /**
         * Gets all layer data in the current map extent that are visible, and put the data into the data grid.
         * @method applyExtentFilter
         */
        function applyExtentFilter() {
            var visibleFeatures = {},
                visibleGridLayers = RampMap.getVisibleFeatureLayers(),
                q = new EsriQuery();

            q.geometry = RampMap.getMap().extent;
            q.outFields = [&quot;*&quot;];

            var deferredList = dojoArray.map(visibleGridLayers, function (gridLayer) {
                return gridLayer.queryFeatures(q).then(function (features) {
                    if (features.features.length &gt; 0) {
                        var layer = features.features[0].getLayer(),
                            layerUrl = layer.url;

                        if (!layer.visible) {
                            visibleFeatures[layerUrl] = [];
                        } else {
                            visibleFeatures[layerUrl] = features.features;
                        }
                    }
                });
            });

            // Execute this only after all the deferred objects has resolved
            utilMisc.afterAll(deferredList, function () {
                fetchRecords(visibleFeatures);
            });
        }

        /**
        * Given a map feature, return a data object used to represent the feature in the data grid.
        *
        * @method getDataObject
        * @private
        * @param {Object} feature the feature needs to be represented in the data grid
        * return {Array} an array representing the data the given feature contains.
        */
        function getDataObject(feature) {
            //TODO call the template here???

            var url = feature.getLayer().url;
            //attribute = feature.attributes;

            //Remember, case sensitivity MATTERS in the attribute name.

            var innerArray,
                tmplData;

            //TODO change to have a new parameter that indicates what kind of data object we want:
            //     a summary object or full grid object.  For now, hardcode to true to always pick summary

            if (true) {
                var sumTemplate = getGridConfig(url).summaryRowTemplate;

                tmpl.cache = {};

                //TODO can we cache this parsed value?  we will use this template possibly twice for every feature.
                //     will save some processing if we dont stringify and parse it every darn time.
                tmpl.templates = JSON.parse(tmplHelper.stringifyTemplate(data_grid_template_json));

                //bundle feature into the template data object
                tmplData = tmplHelper.dataBuilder(feature, url);

                //result of template placed in an array
                innerArray = [tmpl(sumTemplate, tmplData)];
            } else {
                //make array containing values for each column in the full grid
                var row = [];

                tmpl.cache = {};

                tmpl.templates = JSON.parse(tmplHelper.stringifyTemplate(extended_datagrid_template_json));

                //bundle feature into the template data object
                tmplData = tmplHelper.dataBuilder(feature, url);

                // retrieve extendedGrid config object
                var extendedGrid = getGridConfig(url).extendedGridColumns;

                // add columnIdx property, and set initial value
                tmplData.columnIdx = 0;

                // process each column and add to row
                for (var i = 0; i &lt; extendedGrid.length; i++) {
                    // set columnIdx for template
                    tmplData.columnIdx = i;
                    row.push(tmpl(extendedGrid[i].columnTemplate, tmplData));
                }

                innerArray = row;
            }

            //TODO may want to move the generation of this custom object to a separate area, as this data will be useful in
            //     both the summary and full grid state.  Will need some thinking

            // Includes fields that are useful which are not derived from the config.featureSources
            // this should not draw, as there will be no column defined for it
            innerArray.push({
                &quot;featureUrl&quot;: url,
                &quot;layerName&quot;: Ramp.getLayerConfig(url).displayName,
                &quot;feature&quot;: feature
            });

            return innerArray;
        }

        /**
        * Populate the data grid with data in visibleFeatures
        *
        * @method fetchRecords
        * @param {Array} visibleFeatures a dictionary mapping
        * service url to an array of feature objects
        * @private
        */
        function fetchRecords(visibleFeatures) {
            jqgrid.dataTable().fnClearTable();
            jqgrid.dataTable().fnPageChange(0);

            if (Object.keys(visibleFeatures).isEmpty()) {
                return;
            }

            var data = [];

            //for each feature layer
            utilDict.forEachEntry(visibleFeatures, function (key, features) {
                //for each feature in a specific layer
                data = data.concat(dojoArray.map(features, function (feature) {
                    //return the appropriate data object for the feature (.map puts them in array form)

                    // &quot;cache&quot; the data object so we don&#x27;t have to generate it again
                    if (!feature.rampDataObj) {
                        //TODO need an extended and summary data object to handle both grid states
                        feature.rampDataObj = getDataObject(feature);
                    }

                    return feature.rampDataObj;
                }));
            });

            //TODO keep sort for now just for sanity.  will overhaul later
            data.sort(sortFcns[currentSortFcn]);

            utilMisc.subscribeOnce(EventManager.Datagrid.DRAW_COMPLETE, function () {
                // Draw complete fires after fnAddData is complete and the datagrid UI
                // finishes updating
                ui.activateRows();

                ui.adjustPanelWidth();

                topic.publish(EventManager.Datagrid.EXTENT_FILTER_END);
            });

            //add the data to the grid
            try {
                jqgrid.dataTable().fnAddData(data);
            } catch (e) {
                console.error(e);
            }

            // NOTE: fnAddData should be the last thing that happens in this function
            // if you want to add something after this point, use the fnDrawCallback
            // function in the jqgrid initialization
        }

        /**
        * Returns the graphic object of a feature layer which is contained in the given buttonNode.
        *
        * @method getGraphicFromButton
        * @private
        * @param {JObject} buttonNode   the node containing the feature layer
        * @return {Object}   the graphic object of the feature layer.
        */
        function getGraphicFromButton(buttonNode) {
            var featureUrl = buttonNode.data(featureUrlField),
            // Need to parse the index into an integer since it
            // comes as a String
                oid = parseInt(buttonNode.data(featureOidField)),
                featureLayer = RampMap.getFeatureLayer(featureUrl),

                graphic = utilArray.binaryFind(featureLayer.graphics,
                    function (a_graphic) {
                        return GraphicExtension.getOid(a_graphic) - oid;
                    });

            return graphic;
        }

        /**
        * Binding event handling for events:
        * filterManager/layer-visibility-toggled
        * filterManager/global-layer-visibility-toggled
        * datagrid/applyExtentFilter
        *
        * @method initListeners
        * @private
        */

        function initListeners() {
            topic.subscribe(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, function () {
                extentFilterExpired = true;
            });

            topic.subscribe(EventManager.FilterManager.GLOBAL_LAYER_VISIBILITY_TOGGLED, function () {
                extentFilterExpired = true;
            });

            /* UI EVENTS */
            topic.subscribe(EventManager.GUI.TAB_SELECTED, function (arg) {
                if ((arg.tabName === &quot;datagrid&quot;) &amp;&amp; (extentFilterExpired)) {
                    extentFilterExpired = false;
                    applyExtentFilter();
                } else if ((arg.tabName === &quot;datagrid&quot;) &amp;&amp; (!extentFilterExpired)) {
                    ui.capturePanel();
                } else {
                    ui.adjustPanelWidth();
                }
            });

            topic.subscribe(EventManager.GUI.TAB_DESELECTED, function (arg) {
                if (arg.tabName === &quot;datagrid&quot;) {
                    ui.onHide();

                    topic.publish(EventManager.GUI.SUBPANEL_DOCK, {
                        origin: &quot;datagrid&quot;
                    });
                    console.log(&quot;subPanleDock&quot;);
                }
            });

            topic.subscribe(EventManager.Datagrid.APPLY_EXTENT_FILTER, function () {
                if (!ui.isReady()) {
                    ui.init();
                }

                applyExtentFilter();
            });
        }

        return {
            init: function () {
                /// &lt;summary&gt;
                /// initialize the datagrid. must be called before any properties can be accessed.
                /// &lt;/summary&gt;
                config = GlobalStorage.config;
                layerConfig = config.featureLayers;
                gridConfig = layerConfig[0].datagrid;  //this is just to configure the structure of the grid.  since all layers have same structure, just pick first one

                initListeners();

                /**
                * Sort by feature name, then by oid, then by feature url (alphabetically ascending)
                *
                * @method featureSorter
                * @private
                * @param {Object} e1 custom data object
                * @param {Object} e2
                * @return {Integer} a positive integer if e1 is greater (in sort order) than e2, a negative integer
                * if e2 is greater than e1, 0 if the two are considered equal by sort order
                */
                function featureSorter(e1, e2) {
                    var result = e1[0].localeCompare(e2[0]);
                    if (result === 0) {
                        result = e1[1] - e2[1]; // oids are integers
                        if (result === 0) {
                            result = e1.last().featureUrl.localeCompare(e2.last().featureUrl);
                        }
                    }
                    return result;
                }

                /**
                * Sorts by layer name then by feature (alphabetically ascending)
                *
                * @method sortFcns
                * @param {Object} e1 custom data object
                * @param {Object} e2
                * @return {Array} A array of sorted objects
                */
                sortFcns[&quot;default&quot;] = function (e1, e2) {
                    var layerName1 = e1.last().layerName,
                        layerName2 = e2.last().layerName,
                        result = layerName1.localeCompare(layerName2);

                    if (result === 0) {
                        result = featureSorter(e1, e2);
                    }

                    return result;
                };

                sortFcns.ascending = featureSorter;

                sortFcns.descending = function (e1, e2) {
                    // Swap the order the parameters are passed in to make it
                    // descending
                    return featureSorter(e2, e1);
                };
            } //InitDataGrid
        };
    });
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
